!function(){return function e(t,r,s){function o(i,l){if(!r[i]){if(!t[i]){var a="function"==typeof require&&require;if(!l&&a)return a(i,!0);if(n)return n(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var f=r[i]={exports:{}};t[i][0].call(f.exports,function(e){return o(t[i][1][e]||e)},f,f.exports,e,t,r,s)}return r[i].exports}for(var n="function"==typeof require&&require,i=0;i<s.length;i++)o(s[i]);return o}}()({1:[function(require,module,exports){const{Node:Node,Way:Way,Relation:Relation}=require("./osmobjs.js"),{RefElements:RefElements}=require("./utils.js"),XmlParser=require("./xmlparser.js");module.exports=((osm,opts)=>{let refElements=new RefElements,featureArray=[],analyzefeaturesFromJson=()=>{for(let elem of osm.elements)switch(elem.type){case"node":let node=new Node(elem.id,refElements);elem.tags&&node.addTags(elem.tags),node.setCoords([elem.lon,elem.lat]),node.addTags(elem.tags);break;case"way":let way=new Way(elem.id,refElements);if(elem.tags&&way.addTags(elem.tags),elem.nodes)for(let e of elem.nodes)way.addNodeRef(e);else if(elem.geometry)for(let e of elem.geometry)way.addCoords([e.lon,e.lat]);break;case"relation":let relation=new Relation(elem.id,refElements);if(elem.bounds)with(elem.bounds)relation.addProperty("bbox",[parseFloat(minlon),parseFloat(minlat),parseFloat(maxlon),parseFloat(maxlat)]);if(elem.tags&&relation.addTags(elem.tags),elem.members)for(let member of elem.members)relation.addMember(member)}},analyzefeaturesFromXml=()=>{const xmlParser=new XmlParser({progressive:!0});xmlParser.addListener("<osm.relation>",e=>{new Relation(e.$id,refElements)}),xmlParser.addListener("</osm.way>",node=>{with(node){let way=new Way($id,refElements);if(node.innerNodes)for(let nd of innerNodes)nd.$lon&&nd.$lat?way.addCoords([nd.$lon,nd.$lat]):nd.$ref&&way.addNodeRef(nd.$ref)}}),xmlParser.addListener("</osm.node>",node=>{with(node){let nd=new Node($id,refElements);if(nd.setCoords([$lon,$lat]),node.innerNodes)for(let tag of innerNodes)nd.addTag(tag.$k,tag.$v)}}),xmlParser.addListener("<osm.relation>",(node,parent)=>{with(node)new Relation($id,refElements)}),xmlParser.addListener("</osm.relation.member>",(node,parent)=>{with(node){let relation=refElements[parent.$id],member={type:$type,role:node.$role?$role:"",id:$ref,ref:$ref};if(node.$lat&&node.$lon){member.lat=$lat,member.lon=$lon,member.tags={};let entries=Object.entries(node);for(let[k,v]of entries)k.startsWith("$")&&["$lat","$lon","$type"].indexOf(k)<0&&(member.tags[k.substring(1)]=v)}if(node.innerNodes){let geometry=[],nodes=[];for(let ind of innerNodes)ind.$lat&&ind.$lon?geometry.push({lat:ind.$lat,lon:ind.$lon}):nodes.push(ind.$ref);geometry.length>0?member.geometry=geometry:nodes.length>0&&(member.nodes=nodes)}relation.addMember(member)}}),xmlParser.addListener("</osm.relation.bounds>",(e,t)=>refElements[t.$id].addProperty("bbox",[parseFloat(e.$minlon),parseFloat(e.$minlat),parseFloat(e.$maxlon),parseFloat(e.$maxlat)])),xmlParser.addListener("</osm.relation.tag>",(e,t)=>{refElements[t.$id].addTag(e.$k,e.$v)}),xmlParser.parse(osm)};osm.elements?analyzefeaturesFromJson(osm):analyzefeaturesFromXml(osm);let entries=Object.entries(refElements);for(let[k,v]of entries)if(v&&v.refCount<=0)if(v.toFeature){let feature=v.toFeature();feature&&featureArray.push(feature)}else v.toFeatureArray&&(featureArray=featureArray.concat(v.toFeatureArray()));return refElements.cleanup(),opts&&opts.allFeatures||!(featureArray.length>0)?{type:"FeatureCollection",features:featureArray}:featureArray[0].geometry})},{"./osmobjs.js":2,"./utils.js":3,"./xmlparser.js":4}],2:[function(e,t,r){t.exports=(()=>{"use strict";const{first:t,last:r,coordsToKey:s,addToMap:o,removeFromMap:n,getFirstFromMap:i,isRing:l,ringDirection:a,ptInsidePolygon:d,strToFloat:f,LateBinder:h,WayCollection:u}=e("./utils.js");class m{constructor(e,t,r){this.type=e,this.id=t,this.refElems=r,this.tags={},this.properties={id:this.getCompositeId()},this.refCount=0,r&&r.add(t,this)}addTags(e){this.tags=Object.assign(this.tags,e)}addTag(e,t){this.tags[e]=t}addProperty(e,t){this.properties[e]=t}getCompositeId(){return`${this.type}/${this.id}`}getProperties(){return Object.assign(this.properties,this.tags)}unlinkRef(){this.refElems=null}}class p extends m{constructor(e,t){super("node",e,t),this.coords=null}setCoords(e){e instanceof Array&&(this.coords=e)}toFeature(){if(this.coords)return{type:"Feature",id:this.getCompositeId(),properties:this.getProperties(),geometry:{type:"Point",coordinates:f(this.coords)}}}getCoords(){return this.coords}}class c extends m{constructor(e,t){super("way",e,t),this.coordsArray=[]}addCoords(e){this.coordsArray.push(e)}addNodeRef(e){this.coordsArray.push(new h(this.coordsArray,function(e){let t=this.refElems[e];if(t)return t.refCount++,t.getCoords()},this,[e]))}bindRefs(){this.coordsArray.reduce((e,t)=>t instanceof h?e.concat([t]):e,[]).forEach(e=>e.bind())}toCoordsArray(){return this.bindRefs(),this.coordsArray}toFeature(){if(this.bindRefs(),this.coordsArray.length>1)return l(this.coordsArray)?("counterclockwise"!==a(this.coordsArray)&&this.coordsArray.reverse(),{type:"Feature",id:this.getCompositeId(),properties:this.getProperties(),geometry:{type:"Polygon",coordinates:[f(this.coordsArray)]}}):{type:"Feature",id:this.getCompositeId(),properties:this.getProperties(),geometry:{type:"LineString",coordinates:f(this.coordsArray)}}}}return{Node:p,Way:c,Relation:class extends m{constructor(e,t){super("relation",e,t),this.relations=[],this.nodes=[]}addMember(e){switch(e.type){case"relation":this.relations.push(new h(this.relations,function(e){let t=this.refElems[e];if(t)return t.refCount++,t},this,[e.ref]));break;case"way":e.role||e.role;let t=this[e.role];if(t||(t=this[e.role]=[]),e.geometry){let r=new c(e.ref,this.refElems);for(let t of e.geometry)r.addCoords([t.lon,t.lat]),r.refCount++;t.push(r)}else if(e.nodes){let r=new c(e.id,this.refElems);for(let e of nodes)r.addNodeRef(e),r.refCount++;t.push(r)}else t.push(new h(t,function(e){let t=this.refElems[e];if(t)return t.refCount++,t},this,[e.ref]));break;case"node":let r=null;if(e.lat&&e.lon){(r=new p(e.ref,this.refElems)).setCoords([e.lon,e.lat]),e.tags&&r.addTags(e.tags);let t=Object.entries(e);for(let[e,s]of t)"lat"!==e&&"lon"!==e&&"id"!==e&&"tags"!==e&&r.addTag(e,s);r.refCount++,this.nodes.push(r)}else this.nodes.push(new h(this.nodes,function(e){let t=this.refElems[e];if(t)return t.refCount++,t},this,[e.ref]))}}bindRefs(){const e=["relations","nodes","outer","inner",""];for(let t of e){let e=this[t];if(e&&e.length>0){let t=e.slice(0);for(let e of t)e instanceof h?e.bind():e.bindRefs&&e.bindRefs()}}}toFeatureArray(){this.bindRefs();let e=[],r=[],s=[];const o=["outer","inner",""];for(let e of this.relations)if(console.log(e.constructor.name),console.log(e.id),e&&e.bindRefs())for(let t of o){let r=e[t];if(r){let e=this[t];e?[].splice.apply(e,[e.length,0].concat(r)):this[t]=r}}for(let e of o){let t=this[e];if(t){this[e]=new u;for(let r of t)this[e].addWay(r)}}let n=null;this.outer?(n=((e,r)=>{let s=e?e.toRings("counterclockwise"):[],o=r?r.toRings("clockwise"):[];if(s.length>0){let e=[],r=null;for(r of s)e.push([r]);for(;r=o.shift();)for(let o in s)if(d(t(r),s[o])){e[o].push(r);break}return 1===e.length?{type:"Polygon",coordinates:e[0]}:{type:"MultiPolygon",coordinates:e}}return null})(this.outer,this.inner))&&e.push({type:"Feature",id:this.getCompositeId(),properties:this.getProperties(),geometry:n}):this[""]&&(n=(e=>{let t=e?e.toStrings():[];return t.length>0?1===t.length?{type:"LineString",coordinates:t[0]}:{type:"MultiLineString",coordinates:t}:null})(this[""]))&&r.push({type:"Feature",id:this.getCompositeId(),properties:this.getProperties(),geometry:n});for(let e of this.nodes)s.push(e.toFeature());return e.concat(r).concat(s)}}}})()},{"./utils.js":3}],3:[function(e,t,r){t.exports=(()=>{"use strict";let e=e=>e[0],t=e=>e[e.length-1],r=e=>e.join(","),s=(e,t,r)=>{let s=e[t];s?s.push(r):e[t]=[r]},o=(e,t,r)=>{let s=e[t];s&&s.splice(s.indexOf(r),1)},n=(e,t)=>{let r=e[t];return r&&r.length>0?r[0]:null},i=s=>s.length>2&&r(e(s))===r(t(s)),l=(e,t,r)=>{t=t||0,r=r||1;let s=e.reduce((r,s,o)=>e[r][t]>s[t]?r:o,0),o=s<=0?e.length-1:s-1,n=s>=e.length-1?0:s+1,i=e[o][t],l=e[s][t],a=e[n][t],d=e[o][r],f=e[s][r];return(l-i)*(e[n][r]-d)-(a-i)*(f-d)<0?"clockwise":"counterclockwise"},a=e=>e instanceof Array?e.map(a):parseFloat(e);return{first:e,last:t,coordsToKey:r,addToMap:s,removeFromMap:o,getFirstFromMap:n,isRing:i,ringDirection:l,ptInsidePolygon:(e,t,r,s)=>{r=r||0,s=s||1;let o=!1;for(let n=0,i=t.length-1;n<t.length;i=n++)(t[n][r]<=e[r]&&e[r]<t[i][r]||t[i][r]<=e[r]&&e[r]<t[n][r])&&e[s]<(t[i][s]-t[n][s])*(e[r]-t[n][r])/(t[i][r]-t[n][r])+t[n][s]&&(o=!o);return o},strToFloat:a,RefElements:class{add(e,t){this[e]=t}cleanup(){let e=Object.entries(this);for(let[t,r]of e)r&&r.unlinkRef&&r.unlinkRef(),delete this[t]}},LateBinder:class{constructor(e,t,r,s){this.container=e,this.valueFunc=t,this.ctx=r,this.args=s}bind(){let e=this.valueFunc.apply(this.ctx,this.args);if(this.container instanceof Array){let t=[this.container.indexOf(this),1];e&&t.push(e),[].splice.apply(this.container,t)}}},WayCollection:class extends Array{constructor(){super(),this.firstMap={},this.lastMap={}}addWay(o){o=o.toCoordsArray(),this.push(o),s(this.firstMap,r(e(o)),o),s(this.lastMap,r(t(o)),o)}toStrings(){let s=[],i=null;for(;i=this.shift();){o(this.firstMap,r(e(i)),i),o(this.lastMap,r(t(i)),i);let l=i,d=null;do{let s=r(t(l)),i=!1;(d=n(this.firstMap,s))||(d=n(this.lastMap,s),i=!0),d&&(this.splice(this.indexOf(d),1),o(this.firstMap,r(e(d)),d),o(this.lastMap,r(t(d)),d),i&&(d.length>l.length&&([l,d]=[d,l]),d.reverse()),l=l.concat(d.slice(1)))}while(d);s.push(a(l))}return s}toRings(e){let t=this.toStrings(),r=[],s=null;for(;s=t.shift();)i(s)&&(l(s)!=e&&s.reverse(),r.push(s));return r}}}})()},{}],4:[function(e,t,r){t.exports=(()=>{function e(e){return null!=e.match(/^(.+?)\[(.+?)\]>$/g)}function t(e){let t=/^(.+?)\[(.+?)\]>$/g.exec(e);return t?{evt:t[1]+">",exp:t[2]}:{evt:e}}return class{constructor(e){e&&(this.queryParent=!!e.queryParent,this.progressive=e.progressive,this.queryParent&&(this.parentMap=new WeakMap)),this.evtListeners={}}parse(e,t,r){r=r?r+".":"";let s=/<([^ >\/]+)(.*?)>/gm,o=null,n=[];for(;o=s.exec(e);){let i=o[1],l={tag:i},a=r+i,d=o[2].trim(),f=!1;(d.endsWith("/")||i.startsWith("?")||i.startsWith("!"))&&(f=!0);let h=/([^ ]+?)="(.+?)"/g,u=null,m=!1;for(;u=h.exec(d);)m=!0,l[`$${u[1]}`]=u[2];if(m||""===d||(l.text=d),this.progressive&&this.emit(`<${a}>`,l,t),!f){let t=new RegExp(`([^]+?)</${i}>`,"g");t.lastIndex=s.lastIndex;let r=t.exec(e);if(r&&r[1]){s.lastIndex=t.lastIndex;let e=this.parse(r[1],l,a);e.length>0?l.innerNodes=e:l.innerText=r[1]}}this.queryParent&&t&&this.parentMap.set(l,t),this.progressive&&this.emit(`</${a}>`,l,t),n.push(l)}return n}getParent(e){return this.queryParent?this.parentMap.get(e):null}$addListener(e,t){let r=this.evtListeners[e];r?r.push(t):this.evtListeners[e]=[t]}addListener(r,s){e(r)&&(r=t(r),s.condition=function(e){let t="return "+e.replace(/(\$.+?)(?=[=!.])/g,"node.$&")+";";return new Function("node",t)}(r.exp),r=r.evt),this.$addListener(r,s)}$removeListener(e,t){let r=this.evtListeners[e];r&&r.splice(r.indexOf(t),1)}removeListener(r,s){e(r)&&(r=(r=t(r)).evt),this.$removeListener(r,s)}emit(e,...t){let r=this.evtListeners[e];if(r)for(let e of r)e.condition?!0===e.condition.apply(null,t)&&e.apply(null,t):e.apply(null,t)}on(e,t){this.addListener(e,t)}off(e,t){this.removeListener(e,t)}}})()},{}]},{},[1]);